---
title: ivDiag usage examples
author: Apoorva Lal
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  html_document:
    self_contained: true
    theme: flatly
    highlight: tango
    toc: true
    toc_float: true
    toc_depth: 3
---

<style type="text/css">
.main-container {
  max-width: 1200px;
  margin-left: auto;
  margin-right: auto;
}
</style>

```{r, include = F}
library(knitr)
knitr::opts_chunk$set(echo = T, include = T, warning = F, message = F, cache   = T)
```


`ivDiag` is a package for uncertainty quantification and sensitivity
analysis for IV designs that provides `R` implementations of the
guidelines proposed in Lal et al (2021).

The package provides functions to compute (block-)bootstrapped
standard errors, F-statistics, and weak-IV robust confidence intervals
as well as the Local-to-Zero estimator (Conley, Hansen, and Ross
2012). This package is a work in progress.

# Uncertainty Quantification

```{r}
library(ivDiag); library(ggplot2)
# %% Meredith (2013) APSR data
df <-readRDS("../tmp/apsr_Meredith_2013.rds")
Y <- "DemShareDB"; D <- "DemShareGOV"; Z <- "HomeGOV"
controls <- c("HomeDB")
cl <- "fips"
FE <- c("fips","RaceID")
weights <- "Weight"
```


## First Stage Testing

```{r}
# %% first stage F statistics
fst = first_stage_tests(data=df, Y=Y, D=D, Z=Z, controls=controls, FE =FE,
  cl=cl, weights=weights, boot = T, nboot = 100)
fst |> print()
```


## Bootstrap / Block-bootstrap Standard Errors and F Statistic

```{r}
bootres=boot_IV(data=df, Y=Y, D=D, Z=Z, controls=controls, FE = FE,
  cl=cl, weights=weights, nboot = 100)
bootres |> print()
```


### Weak-IV robust Anderson-Rubin test

Fork of `ivmodel::AR.test` that uses `felm` to partial out and fit the
IV regression instead of `AER` and can fit larger models.

```{r}
AR_test(df, Y, D, Z, controls, FE) |> print()
```


# Sensitivity Analysis

## Zero-First-Stage

Example from guiso sapienza & zingales 2016.

```{r}
library(magrittr); library(patchwork); library(ggfortify); library(ggplot2)
library(lfe)

source("../R/utils.R")
load('../tmp/GSZ2016.rds')

# formula
f = formula_lfe('totassoc_p',
  X = c('altitudine', 'escursione', 'costal', 'nearsea', 'population', 'pop2', 'gini_land', 'gini_income' ),
  W = 'libero_comune_allnord', Z = "bishopcity")

# vanilla clustered fit
m1 = felm(f, data = gsz_2016, weights = gsz_2016$population) |> robustify()

# bootstrap fit
m2 = felm(f, data = gsz_2016, weights = gsz_2016$population,
  Nboot = 1000, nostats=structure(FALSE,boot=TRUE))
iv_boots = m2$boot["`libero_comune_allnord(fit)`", ] %>% data.frame(ivb = .)
```

### LtZ estimates

```{r}
zfs_prior # estimate in ZFS south sample - saved in processing
ltz_est = ltz(gsz_2016_residualised, "W", "Z", mu = zfs_prior, sig = 0.1, ivmod = m1)
ltz_est |> print()
```

### Visualising analytic/bootstrap/ltz sampling distributions

```{r}
theme_set(theme_minimal())

lb = -1; ub = 7
analytic_est = m1 %>% summary %>% .$coefficients %>% .[nrow(.), ] %>% .[1:2]
# first - vanilla IV estimates
p0 = ggdistribution(dnorm, seq(lb, ub, 0.01),
  mean = analytic_est[1], sd = analytic_est[2], colour = 'red') +
  xlim(c(lb, ub)) +
  geom_vline(xintercept = analytic_est[1],
    linetype = 'solid', size = 1.5, alpha = 0.5, colour = "red") +
  geom_vline(xintercept = c(analytic_est[1] - 1.96 * analytic_est[2],
            analytic_est[1] + 1.96 * analytic_est[2]),
    linetype = 'dashed', size = 1.5, colour = "red") +
  geom_vline(xintercept = 0, alpha = 0.5) +
  labs(title = "Conventional 2SLS", subtitle = "Nonprofits", x = "", y = "")
# second - bootstrap
p1 = ggplot(iv_boots, aes(x = ivb)) + geom_density(colour = 'blue') +
  xlim(c(lb, ub)) +
  geom_vline(xintercept = quantile(iv_boots$ivb, c(0.025, 0.975)),
    size = 1.5, linetype = 'dotted', colour = 'blue') +
  geom_vline(xintercept = quantile(iv_boots$ivb, c(0.5)),
    size = 1.5,
    colour = 'blue') +
  geom_vline(xintercept = 0, alpha = 0.5) +
  labs(title = "Bootstrap", subtitle = "Nonprofits", x = "", y = "")
# third - local-to-zero
p2 = ggdistribution(dnorm, seq(lb, ub, 0.01),
    mean = ltz_est$est, sd = ltz_est$se, colour = 'olivedrab4') +
  xlim(c(lb, ub)) +
  geom_vline(xintercept = ltz_est$est[1, 1],
    linetype = 'dashed', size = 1.5, colour = "olivedrab4") +
  geom_vline(xintercept = c(ltz_est$ci[1], ltz_est$ci[2]),
    linetype = 'dotted', size = 1.5, colour = "olivedrab4") +
  geom_vline(xintercept = 0, alpha = 0.8) +
  labs(title = "Local-to-zero", subtitle = "Nonprofits", x = "", y = "")

(p0 / p1 / p2)
```
